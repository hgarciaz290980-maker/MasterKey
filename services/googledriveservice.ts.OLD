import AsyncStorage from '@react-native-async-storage/async-storage';
import { GoogleSignin, statusCodes } from '@react-native-google-signin/google-signin';

// CONFIGURACIÓN OFICIAL
GoogleSignin.configure({
  webClientId: '619201497268-rvpm6438n7773l4ir71quoctnemc23st.apps.googleusercontent.com',
  offlineAccess: true,
  scopes: ['https://www.googleapis.com/auth/drive.file'], 
});

export const authenticateWithGoogle = async (): Promise<boolean> => {
  try {
    await GoogleSignin.hasPlayServices();
    
    // Simplificamos: Intentamos login directamente
    const response = await GoogleSignin.signIn();
    
    // Verificamos si es un éxito (en versiones nuevas viene en .data o el objeto directo)
    if (response) {
        const tokens = await GoogleSignin.getTokens();
        await AsyncStorage.setItem('google_access_token', tokens.accessToken);
        await AsyncStorage.setItem('google_connected', 'true');
        return true;
    }
    return false;
  } catch (error: any) {
    if (error.code === statusCodes.SIGN_IN_CANCELLED) {
        console.log("Usuario canceló el login");
    } else {
        console.error("Error Detallado Login:", error.message);
    }
    return false;
  }
};

export const isGoogleConnected = async (): Promise<boolean> => {
    try {
        const user = await GoogleSignin.getCurrentUser();
        return !!user;
    } catch (e) {
        return false;
    }
};

export const logoutFromGoogle = async () => {
    try {
        await GoogleSignin.signOut();
        await AsyncStorage.removeItem('google_access_token');
        await AsyncStorage.removeItem('google_connected');
    } catch (e) {
        console.error("Error al cerrar sesión:", e);
    }
};

export const uploadToGoogleDrive = async (jsonData: string): Promise<boolean> => {
  try {
    // Si no hay tokens, intentamos obtenerlos (esto dispara el login si es necesario)
    const tokens = await GoogleSignin.getTokens();
    const token = tokens.accessToken;

    if (!token) return false;

    const metadata = { 
        name: 'BunkerK_Backup.json', 
        mimeType: 'application/json'
    };
    
    const boundary = 'foo_bar_baz';
    const body = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n` +
                 `--${boundary}\r\nContent-Type: application/json\r\n\r\n${jsonData}\r\n` +
                 `--${boundary}--`;

    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: { 
        Authorization: `Bearer ${token}`,
        'Content-Type': `multipart/related; boundary=${boundary}`
      },
      body: body,
    });

    return response.ok;
  } catch (error) {
    console.error("Error en subida Drive:", error);
    return false;
  }
};